<!-- Contenedor principal de la página de perfil de usuario -->
<div class="page-wrapper">
  <div class="content" *ngIf="profileData">
    <!-- Estándar de Page Header del Proyecto -->
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col">
          <ul class="breadcrumb">
            <li class="breadcrumb-item">
              <a>{{ 'PROFILE.PROFILES.DASHBOARD' | translate }}</a>
            </li>
            <li class="breadcrumb-item"><i class="fa fa-chevron-right"></i></li>
            <li class="breadcrumb-item active">{{ 'PROFILE.PROFILES.PROFILES' | translate }}</li>
          </ul>
        </div>
        <div class="col-auto text-end float-end ms-auto">
          <!-- Botón para cambiar correo -->
          <button (click)="openEmailModal()" class="btn btn-info btn-rounded text-white me-2">
            <i class="fa fa-envelope"></i> {{ 'PROFILE.PROFILES.EMAIL_CHANGE.TITLE' | translate }}
          </button>
          <!-- Botón para cambiar contraseña -->
          <a [routerLink]="routes.changePassword" class="btn btn-warning btn-rounded me-2">
            <i class="fa fa-lock"></i> {{ 'PROFILE.PROFILES.CHANGE_PASSWORD' | translate }}
          </a>
          <!-- Botón para editar el perfil -->
          <a [routerLink]="routes.editProfile" class="btn btn-primary btn-rounded">
            <i class="fa fa-pencil"></i> {{ 'PROFILE.PROFILES.EDIT_PROFILE' | translate }}
          </a>
        </div>
      </div>
    </div>

    <!-- Cabecera del perfil con foto destacada -->
    <div class="card-box profile-header">
      <!-- Foto de perfil destacada en el centro -->
      <div class="profile-avatar-container">
        <div class="avatar-wrapper">
          <img class="profile-avatar" [src]="profileData?.avatar || 'assets/img/default.png'"
            alt="Avatar del usuario" />
          <div class="avatar-glow"></div>
        </div>
        <div class="profile-name-section">
          <h1 class="profile-name">{{ profileData?.name }} {{ profileData?.surname }}</h1>
          <div class="profile-role">
            <i class="fa fa-briefcase"></i>
            <span>{{ roles[0] }}</span>
          </div>
        </div>
      </div>

      <!-- Información de contacto debajo -->
      <div class="profile-contact-grid">
        <div class="contact-card" *ngIf="profileData?.email">
          <div class="contact-icon">
            <i class="fa fa-envelope"></i>
          </div>
          <div class="contact-details">
            <span class="contact-label">{{ 'PROFILE.PROFILES.EMAIL' | translate }}</span>
            <span class="contact-value">{{ profileData.email }}</span>
          </div>
        </div>

        <div class="contact-card" *ngIf="profileData?.mobile">
          <div class="contact-icon">
            <i class="fa fa-phone"></i>
          </div>
          <div class="contact-details">
            <span class="contact-label">{{ 'PROFILE.PROFILES.PHONE' | translate }}</span>
            <span class="contact-value">{{ profileData.mobile }}</span>
          </div>
        </div>

        <div class="contact-card" *ngIf="profileData?.birth_date">
          <div class="contact-icon">
            <i class="fa fa-calendar"></i>
          </div>
          <div class="contact-details">
            <span class="contact-label">{{ 'PROFILE.PROFILES.BIRTH_DATE' | translate }}</span>
            <span class="contact-value">{{ profileData.birth_date }}</span>
          </div>
        </div>

        <div class="contact-card" *ngIf="profileData?.gender !== undefined || profileData?.gender_id !== undefined">
          <div class="contact-icon">
            <i class="fa fa-user"></i>
          </div>
          <div class="contact-details">
            <span class="contact-label">{{ 'PROFILE.PROFILES.GENDER' | translate }}</span>
            <span class="contact-value">{{ profileData?.gender ? profileData.gender : (profileData?.gender_id === 1 ?
              'Masculino' : (profileData?.gender_id === 2 ? 'Femenino' : '—')) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Información de la licencia del sistema -->
    <div class="card-box license-card mt-4">
      <div class="license-header">
        <div class="license-icon">
          <i class="fa fa-key"></i>
        </div>
        <div class="license-title-section">
          <h4 class="card-title mb-0">{{ 'PROFILE.PROFILES.SYSTEM_LICENSE' | translate }}</h4>
          <p class="license-subtitle">{{ 'PROFILE.PROFILES.SOFTWARE_LICENSE_INFO' | translate }}</p>
        </div>
      </div>

      <div *ngIf="loadingLicense" class="license-loading">
        <i class="fa fa-spinner fa-spin"></i>
        <span>{{ 'PROFILE.PROFILES.LOADING_LICENSE_INFO' | translate }}</span>
      </div>

      <div *ngIf="!loadingLicense && licenseInfo" class="license-content">
        <!-- Estado destacado -->
        <div class="license-status-card" [ngClass]="{
          'status-active': licenseInfo.is_valid && (isPermanentLicense() || licenseInfo.days_remaining > 30),
          'status-warning': licenseInfo.is_valid && !isPermanentLicense() && licenseInfo.days_remaining <= 30 && licenseInfo.days_remaining > 0,
          'status-danger': !licenseInfo.is_valid || (!isPermanentLicense() && licenseInfo.days_remaining <= 0)
        }">
          <div class="status-icon">
            <i class="fa" [ngClass]="{
              'fa-check-circle': licenseInfo.is_valid && (isPermanentLicense() || licenseInfo.days_remaining > 30),
              'fa-exclamation-triangle': licenseInfo.is_valid && !isPermanentLicense() && licenseInfo.days_remaining <= 30 && licenseInfo.days_remaining > 0,
              'fa-times-circle': !licenseInfo.is_valid || (!isPermanentLicense() && licenseInfo.days_remaining <= 0)
            }"></i>
          </div>
          <div class="status-info">
            <span class="status-label">{{ 'PROFILE.PROFILES.LICENSE_STATUS' | translate }}</span>
            <span class="status-value">
              {{ licenseInfo.is_valid && (isPermanentLicense() || licenseInfo.days_remaining > 0) ? 'Activa' :
              'Inválida/Expirada' }}
            </span>
            <span class="status-type" *ngIf="licenseInfo.is_valid">
              ({{ getLicenseType() }})
            </span>
          </div>
          <div class="status-days" *ngIf="!isPermanentLicense() && licenseInfo.days_remaining > 0">
            <span class="days-number">{{ licenseInfo.days_remaining }}</span>
            <span class="days-label">{{ 'PROFILE.PROFILES.DAYS_REMAINING' | translate }}</span>
          </div>
          <div class="status-days status-permanent" *ngIf="isPermanentLicense()">
            <i class="fa fa-infinity"></i>
            <span class="days-label">{{ 'PROFILE.PROFILES.LICENSE_PERMANENT' | translate }}</span>
          </div>
        </div>

        <!-- Información en grid -->
        <div class="license-info-grid">
          <div class="info-item">
            <div class="info-icon">
              <i class="fa fa-building"></i>
            </div>
            <div class="info-content">
              <span class="info-label">{{ 'PROFILE.PROFILES.INSTITUTION' | translate }}</span>
              <span class="info-value">{{ licenseInfo.institution }}</span>
            </div>
          </div>

          <!-- Alertas según días restantes -->
          <div class="license-alerts" *ngIf="!isPermanentLicense()">
            <div *ngIf="licenseInfo.days_remaining <= 7 && licenseInfo.days_remaining > 0"
              class="license-alert alert-critical">
              <i class="fa fa-exclamation-triangle"></i>
              <div class="alert-content">
                <strong>{{ 'PROFILE.PROFILES.ALERTS.URGENT_ATTENTION' | translate }}</strong>
                <p>{{ 'PROFILE.PROFILES.ALERTS.LICENSE_EXPIRING_SOON' | translate }}</p>
                <div class="alert-contact">
                  <div class="contact-item">
                    <i class="fa fa-envelope"></i>
                    <span>soporte@sismeg.gob.mx</span>
                  </div>
                  <div class="contact-item">
                    <i class="fa fa-phone"></i>
                    <span>+52 (999) 123-4567</span>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="licenseInfo.days_remaining > 7 && licenseInfo.days_remaining <= 30"
              class="license-alert alert-warning">
              <i class="fa fa-exclamation-circle"></i>
              <div class="alert-content">
                <strong>{{ 'PROFILE.PROFILES.ALERTS.UPCOMING_RENEWAL' | translate }}</strong>
                <p>{{ 'PROFILE.PROFILES.ALERTS.LICENSE_EXPIRING_SOON' | translate }}</p>
                <div class="alert-contact">
                  <div class="contact-item">
                    <i class="fa fa-envelope"></i>
                    <span>soporte@sismeg.gob.mx</span>
                  </div>
                  <div class="contact-item">
                    <i class="fa fa-phone"></i>
                    <span>+52 (999) 123-4567</span>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="licenseInfo.days_remaining <= 0" class="license-alert alert-expired">
              <i class="fa fa-times-circle"></i>
              <div class="alert-content">
                <strong>{{ 'PROFILE.PROFILES.ALERTS.EXPIRED_LICENSE' | translate }}</strong>
                <p>{{ 'PROFILE.PROFILES.ALERTS.EXPIRED_LICENSE_MESSAGE' | translate }}</p>
                <div class="alert-contact">
                  <div class="contact-item">
                    <i class="fa fa-envelope"></i>
                    <span>soporte@sismeg.gob.mx</span>
                  </div>
                  <div class="contact-item">
                    <i class="fa fa-phone"></i>
                    <span>+52 (999) 123-4567</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Alerta para licencias permanentes -->
          <div class="license-alerts" *ngIf="isPermanentLicense()">
            <div class="license-alert alert-success">
              <i class="fa fa-check-circle"></i>
              <div class="alert-content">
                <strong>{{ 'PROFILE.PROFILES.ALERTS.PERMANENT_LICENSE' | translate }}</strong>
                <p>{{ 'PROFILE.PROFILES.ALERTS.PERMANENT_LICENSE_MESSAGE' | translate }}</p>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!loadingLicense && !licenseInfo" class="license-error">
          <i class="fa fa-exclamation-circle"></i>
          <div class="error-content">
            <strong>{{ 'PROFILE.PROFILES.ERRORS.LOAD_LICENSE' | translate }}</strong>
            <p>{{ 'PROFILE.PROFILES.ERRORS.CONTACT_ADMIN' | translate }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para cambio de correo electrónico (Ahora dentro de .content) -->
    <div class="custom-modal-overlay" *ngIf="showEmailModal" (click)="closeEmailModal()">
      <div class="custom-modal-content card" (click)="$event.stopPropagation()">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white py-3">
          <h5 class="modal-title mb-0">
            <i class="fa fa-envelope-o me-2"></i>
            {{ 'PROFILE.PROFILES.EMAIL_CHANGE.TITLE' | translate }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeEmailModal()"></button>
        </div>

        <div class="card-body p-4">
          <!-- Paso 1: Solicitar cambio -->
          <div *ngIf="emailStep === 'request'" class="text-center">
            <div class="step-icon mb-4">
              <i class="fa fa-paper-plane-o fa-2x text-primary"></i>
            </div>
            <p class="text-muted mb-4">
              {{ 'PROFILE.PROFILES.EMAIL_CHANGE.REQUEST_DESC' | translate }}
              <br><strong>{{ profileData.email }}</strong>
            </p>

            <div class="form-group mb-3 text-start">
              <label class="form-label font-weight-bold">{{ 'PROFILE.PROFILES.EMAIL_CHANGE.NEW_EMAIL' | translate
                }}</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fa fa-envelope"></i></span>
                <input type="email" class="form-control" [(ngModel)]="newEmail"
                  placeholder="{{ 'PROFILE.PROFILES.EMAIL_CHANGE.PLACEHOLDER' | translate }}">
              </div>
            </div>

            <div *ngIf="emailError" class="alert alert-danger py-2 small mb-3">
              <i class="fa fa-exclamation-circle me-1"></i> {{ emailError }}
            </div>

            <button class="btn btn-primary w-100 py-2 mt-2" (click)="requestEmailChange()" [disabled]="emailLoading">
              <i class="fa" [ngClass]="emailLoading ? 'fa-spinner fa-spin' : 'fa-arrow-right'"></i>
              {{ 'PROFILE.PROFILES.EMAIL_CHANGE.SEND_CODE' | translate }}
            </button>
          </div>

          <!-- Paso 2: Confirmar código -->
          <div *ngIf="emailStep === 'confirm'" class="text-center">
            <div class="step-icon mb-4">
              <i class="fa fa-shield fa-2x text-success"></i>
            </div>
            <p class="text-muted mb-4">
              {{ 'PROFILE.PROFILES.EMAIL_CHANGE.CONFIRM_DESC' | translate }}
            </p>

            <div *ngIf="emailSuccess" class="alert alert-success py-2 small mb-3">
              <i class="fa fa-check-circle me-1"></i> {{ emailSuccess }}
            </div>

            <div class="form-group mb-4">
              <label class="form-label font-weight-bold">{{ 'PROFILE.PROFILES.EMAIL_CHANGE.VERIFICATION_CODE' |
                translate
                }}</label>
              <input type="text" class="form-control text-center verification-input py-2" [(ngModel)]="verificationCode"
                maxlength="8" placeholder="00000000" style="font-size: 1.5rem; letter-spacing: 5px; font-weight: bold;">
            </div>

            <div *ngIf="emailError" class="alert alert-danger py-2 small mb-3">
              <i class="fa fa-exclamation-circle me-1"></i> {{ emailError }}
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary flex-1 py-2"
                (click)="emailStep = 'request'; emailError = ''; emailSuccess = ''">
                <i class="fa fa-arrow-left me-1"></i> Atrás
              </button>
              <button class="btn btn-primary flex-1 py-2" (click)="confirmEmailChange()" [disabled]="emailLoading">
                <i class="fa" [ngClass]="emailLoading ? 'fa-spinner fa-spin' : 'fa-check'"></i>
                {{ 'PROFILE.PROFILES.EMAIL_CHANGE.CONFIRM_CHANGE' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>