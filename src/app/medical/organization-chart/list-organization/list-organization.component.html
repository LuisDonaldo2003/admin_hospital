<!-- Contenedor principal de la página de organización -->
<div class="page-wrapper">
  <!-- Contenido principal de la lista de personal -->
  <div class="content list-staff">
    
  <!-- Encabezado de la página con breadcrumb de navegación -->
    <div class="page-header mb-4">
      <div class="row">
        <div class="col-sm-12">
          <!-- Breadcrumb moderno con iconos -->
          <ol class="breadcrumb bg-light p-3 rounded-lg shadow-sm">
            <li class="breadcrumb-item">
              <i class="fas fa-sitemap me-2 text-primary"></i>
              {{ 'ORGANIZATION.LIST_ORGANIZATION.BREADCRUMB' | translate }}
            </li>
            <li class="breadcrumb-item active fw-bold">
              <i class="fas fa-users me-2"></i>
              {{ 'ORGANIZATION.LIST_ORGANIZATION.BREADCRUMB_USERS_BY_ROLE' | translate }}
            </li>
          </ol>
        </div>
      </div>
    </div>

  <!-- Mensaje de carga -->
    <div *ngIf="loading" class="loading">
      <div class="d-flex flex-column align-items-center">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">{{ 'ORGANIZATION.LIST_ORGANIZATION.LOADING' | translate }}</span>
        </div>
        <h5 class="text-muted">{{ 'ORGANIZATION.LIST_ORGANIZATION.LOADING' | translate }}...</h5>
        <p class="text-secondary">Obteniendo información del organigrama</p>
      </div>
    </div>

  <!-- Sección principal con animaciones -->
    <div *ngIf="!loading" class="fade-in">
      
  <!-- Estadísticas rápidas -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card bg-success">
            <div class="stats-icon">
              <i class="fas fa-circle text-success"></i>
            </div>
            <div class="stats-content">
              <h4>{{ getOnlineUsersCount() }}</h4>
              <span>Usuarios Online</span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card bg-danger">
            <div class="stats-icon">
              <i class="fas fa-circle text-danger"></i>
            </div>
            <div class="stats-content">
              <h4>{{ getOfflineUsersCount() }}</h4>
              <span>Usuarios Offline</span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card bg-primary">
            <div class="stats-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stats-content">
              <h4>{{ users.length }}</h4>
              <span>Total Usuarios</span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card bg-info">
            <div class="stats-icon">
              <i class="fas fa-user-tag"></i>
            </div>
            <div class="stats-content">
              <h4>{{ getRolesCount() }}</h4>
              <span>Roles Activos</span>
            </div>
          </div>
        </div>
      </div>

  <!-- Contenedor del organigrama -->
      <div class="org-chart">
        
  <!-- Sección especial para Dirección -->
  <div class="card border-0 shadow-lg role-section" 
       *ngIf="(rolesMap['Director General']?.length || 0) + (rolesMap['Subdirector General']?.length || 0) > 0">
          <div class="card-header position-relative">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-0">
                <i class="fas fa-crown me-2"></i>
                {{ 'ORGANIZATION.LIST_ORGANIZATION.DIRECTION' | translate }}
              </h5>
                <span class="badge bg-light text-dark">
                {{ (rolesMap['Director General'].length || 0) + (rolesMap['Subdirector General'].length || 0) }} 
                miembros
              </span>
            </div>
          </div>
          
          <div class="card-body">
            <div class="users-row">
              
              <!-- Director General -->
              <ng-container *ngFor="let user of (rolesMap['Director General'] || []); let i = index">
                <div class="user-card" 
                     [style.animation-delay]="(i * 0.1) + 's'"
                     (click)="onUserClick(user)"
                     [attr.data-user-id]="user.id">
                  
                  <div class="avatar-wrapper">
                    <!-- Avatar con fallback -->
                    <img *ngIf="user.avatar; else avatarFallback" 
                         [src]="user.avatar" 
                         [alt]="user.name + ' ' + user.surname"
                         class="avatar-large"
                         (error)="onImageError($event)"/>
                    
                    <ng-template #avatarFallback>
                      <div class="avatar-large d-flex align-items-center justify-content-center bg-primary text-white">
                        <i class="fas fa-user fa-2x"></i>
                      </div>
                    </ng-template>
                    
                    <!-- Badge de rol -->
                    <div class="role-badge director">
                      <i class="fas fa-star"></i>
                    </div>
                  </div>
                  
                  <div class="user-info">
                    <div class="user-name">{{ user.name }} {{ user.surname }}</div>
                    <div class="user-role text-primary fw-bold">Director General</div>
                    <div class="user-status">
                      <span class="badge status-pill" [ngClass]="{ 'bg-success': isOnline(user), 'bg-secondary': !isOnline(user) }">
                        <i class="fas fa-circle me-1"></i>
                        {{ isOnline(user) ? 'En línea' : 'Desconectado' }}
                      </span>
                    </div>
                  </div>
                </div>
              </ng-container>
              
              <!-- Subdirector General -->
              <ng-container *ngFor="let user of (rolesMap['Subdirector General'] || []); let i = index">
                <div class="user-card"
                     [style.animation-delay]="((rolesMap['Director General'].length || 0) + i * 0.1) + 's'"
                     (click)="onUserClick(user)"
                     [attr.data-user-id]="user.id">
                  
                  <div class="avatar-wrapper">
                    <img *ngIf="user.avatar; else avatarFallback" 
                         [src]="user.avatar" 
                         [alt]="user.name + ' ' + user.surname"
                         class="avatar-large"
                         (error)="onImageError($event)"/>
                    
                    <ng-template #avatarFallback>
                      <div class="avatar-large d-flex align-items-center justify-content-center bg-info text-white">
                        <i class="fas fa-user fa-2x"></i>
                      </div>
                    </ng-template>
                    
                    <div class="role-badge subdirector">
                      <i class="fas fa-star"></i>
                    </div>
                  </div>
                  
                  <div class="user-info">
                    <div class="user-name">{{ user.name }} {{ user.surname }}</div>
                    <div class="user-role text-info fw-bold">Subdirector General</div>
                    <div class="user-status">
                      <span class="badge status-pill" [ngClass]="{ 'bg-success': isOnline(user), 'bg-secondary': !isOnline(user) }">
                        <i class="fas fa-circle me-1"></i>
                        {{ isOnline(user) ? 'En línea' : 'Desconectado' }}
                      </span>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
        
  <!-- Secciones para otros roles -->
        <ng-container *ngFor="let role of (rolesMap ? (rolesMap | keyvalue) : []); let roleIndex = index">
          <div *ngIf="role.key !== 'Director General' && role.key !== 'Subdirector General'"
               class="card border-0 shadow-lg role-section"
               [style.animation-delay]="(roleIndex * 0.15) + 's'">
            
            <div class="card-header position-relative">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">
                  <i [ngClass]="getRoleIcon(role.key)" class="me-2"></i>
                  {{ role.key }}
                </h5>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-light text-dark">
                    {{ role.value.length }} miembros
                  </span>
                  <span class="badge bg-success" *ngIf="getOnlineCountForRole(role.value) > 0">
                    {{ getOnlineCountForRole(role.value) }} online
                  </span>
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <div class="users-row">
                <div *ngFor="let user of role.value; let userIndex = index" 
                     class="user-card"
                     [style.animation-delay]="(roleIndex * 0.1 + userIndex * 0.05) + 's'"
                     (click)="onUserClick(user)"
                     [attr.data-user-id]="user.id">
                  
                  <div class="avatar-wrapper">
                    <img *ngIf="user.avatar; else avatarFallback" 
                         [src]="user.avatar" 
                         [alt]="user.name + ' ' + user.surname"
                         class="avatar-large"
                         (error)="onImageError($event)"/>
                    
                    <ng-template #avatarFallback>
                      <div class="avatar-large d-flex align-items-center justify-content-center bg-secondary text-white">
                        <i class="fas fa-user fa-2x"></i>
                      </div>
                    </ng-template>
                  </div>
                  
                  <div class="user-info">
                    <div class="user-name">{{ user.name }} {{ user.surname }}</div>
                    <div class="user-role text-muted">{{ role.key }}</div>
                    <div class="user-status">
                      <span class="badge status-pill" [ngClass]="{ 'bg-success': isOnline(user), 'bg-secondary': !isOnline(user) }">
                        <i class="fas fa-circle me-1"></i>
                        {{ isOnline(user) ? 'En línea' : 'Desconectado' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
        
  <!-- Sección de estadísticas al final -->
        <div class="stats-summary card border-0 shadow-sm bg-light">
          <div class="card-body text-center">
            <h6 class="text-muted mb-2">Última actualización: {{ getLastUpdateTime() }}</h6>
            <small class="text-secondary">
              Los estados se actualizan automáticamente cada 30 segundos
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>