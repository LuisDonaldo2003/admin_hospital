<!-- Contenedor principal de la página de listado de enseñanzas -->
<div class="page-wrapper">
  <!-- Contenido principal -->
  <div class="content list-staff">

    <!-- Encabezado de la página con breadcrumb de navegación -->
    <div class="page-header mb-4">
      <div class="row">
        <div class="col-sm-12">
          <!-- Breadcrumb para mostrar la ruta actual -->
          <ol class="breadcrumb bg-light p-2 rounded">
            <li class="breadcrumb-item">{{ 'TEACHING_MODULE.ASSISTANTS.BREADCRUMB' | translate }} <span>&gt;</span></li>
            <li class="breadcrumb-item active">{{ 'TEACHING_MODULE.ASSISTANTS.BREADCRUMB_LIST' | translate }}</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Sección de filtros y búsqueda mejorada -->
    <div class="filters-card mb-4">
      <div class="filters-header mb-3">
        <h5 class="mb-0 fw-semibold">
          <i class="fa fa-filter me-2"></i>{{ 'TEACHING_MODULE.ASSISTANTS.FILTERS' | translate }}
        </h5>
      </div>

      <!-- Fila de búsqueda -->
      <div class="row g-3 mb-3">
        <!-- Búsqueda general -->
        <div class="col-lg-6">
          <div class="input-group search-input-group">
            <span class="input-group-text">
              <i class="fa fa-search"></i>
            </span>
            <input type="text" class="form-control"
              placeholder="{{ 'TEACHING_MODULE.ASSISTANTS.SEARCH_PLACEHOLDER' | translate }}" [(ngModel)]="searchTerm"
              (keyup.enter)="searchData()" (input)="searchTerm === '' && searchData()" [disabled]="loading">
          </div>
        </div>

        <!-- Búsqueda por profesión -->
        <div class="col-lg-6">
          <select class="form-select" [(ngModel)]="filtroEspecialidad" (change)="filterData()" [disabled]="loading">
            <option value="">{{ 'TEACHING_MODULE.ASSISTANTS.ALL_PROFESSIONS' | translate }}</option>
            <option *ngFor="let profesion of profesiones" [value]="profesion">
              {{ profesion }}
            </option>
          </select>
        </div>
      </div>

      <!-- Fila de selectores -->
      <div class="row g-3 mb-3">
        <!-- Modalidad -->
        <div class="col-lg-4">
          <select class="form-select" [(ngModel)]="filtroModalidad" (change)="filterData()" [disabled]="loading">
            <option [ngValue]="undefined">{{ 'TEACHING_MODULE.ASSISTANTS.ALL_MODALITIES' | translate }}</option>
            <option *ngFor="let modalidad of modalidades" [ngValue]="modalidad.id">
              {{ modalidad.nombre }}
            </option>
          </select>
        </div>

        <!-- Participación -->
        <div class="col-lg-4">
          <select class="form-select" [(ngModel)]="filtroParticipacion" (change)="filterData()" [disabled]="loading">
            <option [ngValue]="undefined">{{ 'TEACHING_MODULE.ASSISTANTS.ALL_PARTICIPATIONS' | translate }}</option>
            <option *ngFor="let participacion of participaciones" [ngValue]="participacion.id">
              {{ participacion.nombre }}
            </option>
          </select>
        </div>

        <!-- Área -->
        <div class="col-lg-4">
          <select class="form-select" [(ngModel)]="filtroArea" (change)="filterData()" [disabled]="loading">
            <option value="">{{ 'TEACHING_MODULE.ASSISTANTS.ALL_AREAS' | translate }}</option>
            <option *ngFor="let area of areas" [value]="area">
              {{ area }}
            </option>
          </select>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="row g-3">
        <div class="col-lg-4">
          <button class="btn btn-clear w-100" (click)="clearFilters()" [disabled]="loading">
            <i class="fa fa-refresh me-2"></i>
            {{ 'TEACHING_MODULE.ASSISTANTS.CLEAR_FILTERS' | translate }}
          </button>
        </div>
        <div class="col-lg-4">
          <button class="btn btn-evaluaciones w-100" (click)="goToEvaluaciones()" [disabled]="loading">
            <i class="fa fa-clipboard-check me-2"></i>
            {{ 'TEACHING_MODULE.ASSISTANTS.PENDING_EVALUATIONS' | translate }}
          </button>
        </div>
        <div class="col-lg-4">
          <button class="btn btn-add-patient w-100" (click)="addTeaching()" [disabled]="loading" *ngIf="canCreate()">
            <i class="fa fa-plus me-2"></i>
            {{ 'TEACHING_MODULE.ASSISTANTS.NEW_TEACHING' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla de resultados de enseñanzas -->
    <div class="row">
      <div class="col-sm-12">
        <div class="card card-list shadow border-0">
          <div class="card-body">

            <!-- Encabezado de la tabla con totales y spinner de carga -->
            <div class="stats-bar mb-4">
              <div class="stat-item">
                <i class="fa fa-database me-2"></i>
                <span class="stat-label">{{ 'TEACHING_MODULE.ASSISTANTS.TOTAL_GLOBAL' | translate }}:</span>
                <span class="stat-value">{{ stats.total || 0 }}</span>
              </div>
              <div class="d-flex align-items-center gap-3">
                <div class="stat-item">
                  <i class="fa fa-file-medical me-2"></i>
                  <span class="stat-label">{{ 'TEACHING_MODULE.ASSISTANTS.SHOWING' | translate }}:</span>
                  <span class="stat-value">{{ teachingList.length }}</span>
                </div>

                <!-- Botón de Ordenamiento -->
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2" (click)="toggleSort()"
                  [title]="sortDirection === 'desc' ? ('TEACHING_MODULE.ASSISTANTS.SORT_ASC' | translate) : ('TEACHING_MODULE.ASSISTANTS.SORT_DESC' | translate)">
                  <i class="fa" [ngClass]="sortDirection === 'desc' ? 'fa-sort-amount-down' : 'fa-sort-amount-up'"></i>
                  <span class="d-none d-md-inline">{{ sortDirection === 'desc' ? ('TEACHING_MODULE.ASSISTANTS.RECENT' |
                    translate) : ('TEACHING_MODULE.ASSISTANTS.OLDEST' | translate) }}</span>
                </button>

                <div class="stat-item">
                  <i class="fa fa-clock me-2"></i>
                  <span class="stat-label">{{ 'TEACHING_MODULE.ASSISTANTS.TOTAL_HOURS' | translate }}:</span>
                  <span class="stat-value">{{ getTotalHoras() }}</span>
                </div>
                <div *ngIf="loading" class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">{{ 'TEACHING_MODULE.ASSISTANTS.LOADING' | translate }}...</span>
                </div>
              </div>
            </div>

            <!-- Mensaje cuando no hay resultados en la búsqueda -->
            <div *ngIf="!loading && teachingList.length === 0" class="empty-state">
              <div class="empty-icon">
                <i class="fa fa-folder-open"></i>
              </div>
              <h5>{{ 'TEACHING_MODULE.ASSISTANTS.NO_RECORDS' | translate }}</h5>
              <p *ngIf="hasActiveFilters">
                {{ 'TEACHING_MODULE.ASSISTANTS.NO_MATCHING' | translate }}
              </p>
              <button *ngIf="hasActiveFilters" class="btn btn-clear" (click)="clearFilters()">
                <i class="fa fa-refresh me-2"></i>
                {{ 'TEACHING_MODULE.ASSISTANTS.CLEAR_FILTERS' | translate }}
              </button>
            </div>

            <!-- Vista de cards horizontales (solo si hay resultados) -->
            <div class="patients-grid" *ngIf="!loading && teachingList.length > 0">
              <div class="patient-card" *ngFor="let teaching of teachingList; let i = index">

                <!-- Encabezado de la card con número y acciones -->
                <div class="patient-card-header">
                  <div class="expediente-section">
                    <i class="fa fa-chalkboard-teacher"></i>
                    <span class="expediente-number">#{{ rangeStart + i }}</span>
                  </div>

                  <!-- Botones de acción -->
                  <div class="action-buttons-compact">
                    <!-- Botón Expandir/Colapsar -->
                    <button class="btn-icon btn-expand" (click)="toggleCardExpansion(teaching.id)"
                      [title]="isCardExpanded(teaching.id) ? ('TEACHING_MODULE.ASSISTANTS.COLLAPSE' | translate) : ('TEACHING_MODULE.ASSISTANTS.EXPAND' | translate)">
                      <i class="fa" [ngClass]="isCardExpanded(teaching.id) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                    </button>

                    <!-- Botón Editar - solo si tiene permiso -->
                    <button *ngIf="canEdit() && teaching.id" class="btn-icon btn-edit"
                      (click)="editTeaching(teaching.id!)" title="{{ 'TEACHING_MODULE.ASSISTANTS.EDIT' | translate }}">
                      <i class="fa fa-pen"></i>
                    </button>

                    <!-- Botón Eliminar - solo si tiene permiso -->
                    <button *ngIf="canDelete()" class="btn-icon btn-delete" (click)="selectTeaching(teaching)"
                      data-bs-toggle="modal" data-bs-target="#delete_teaching"
                      title="{{ 'TEACHING_MODULE.ASSISTANTS.DELETE' | translate }}">
                      <i class="fa fa-trash"></i>
                    </button>

                    <!-- Badge sin permisos -->
                    <span class="badge badge-no-permission" *ngIf="!canEdit() && !canDelete()">
                      <i class="fa fa-ban me-1"></i>{{ 'TEACHING_MODULE.ASSISTANTS.NO_PERMISSIONS' | translate }}
                    </span>
                  </div>
                </div>

                <!-- Cuerpo de la card con información en layout horizontal -->
                <div class="patient-card-body">
                  <!-- Vista resumida del Asistente (siempre visible) -->
                  <div class="patient-horizontal-info mb-2">

                    <!-- Nombre completo -->
                    <div class="info-block info-name">
                      <i class="fa fa-user-circle"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'TEACHING_MODULE.ASSISTANTS.NAME' | translate }}</span>
                        <span class="info-value-main">{{ teaching.nombre }}</span>
                      </div>
                    </div>

                    <!-- Profesión -->
                    <div class="info-block info-compact">
                      <i class="fa fa-user-md"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'TEACHING_MODULE.ASSISTANTS.PROFESSION' | translate }}</span>
                        <span class="info-value-main">{{ teaching.profesion ||
                          ('TEACHING_MODULE.ASSISTANTS.NOT_AVAILABLE' | translate) }}</span>
                      </div>
                    </div>

                    <!-- Area -->
                    <div class="info-block info-compact">
                      <i class="fa fa-building"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'TEACHING_MODULE.ASSISTANTS.AREA' | translate }}</span>
                        <span class="info-value-main">{{ teaching.area || ('TEACHING_MODULE.ASSISTANTS.NOT_AVAILABLE' |
                          translate) }}</span>
                      </div>
                    </div>

                    <!-- Contador de eventos -->
                    <div class="info-block info-small">
                      <i class="fa fa-list-ol"></i>
                      <div class="info-details">
                        <span class="info-label-small">Eventos</span>
                        <span class="info-value-main text-primary fw-bold">{{ teaching.events_count ||
                          (teaching.events?.length || 0) }}</span>
                      </div>
                    </div>

                  </div>

                  <!-- Segunda fila (Adscripción y Totales del asistente) -->
                  <div class="patient-horizontal-info mb-2">
                    <!-- Adscripción -->
                    <div class="info-block info-location" style="flex: 2;">
                      <i class="fa fa-hospital"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'TEACHING_MODULE.ASSISTANTS.ADSCRIPTION' | translate }}</span>
                        <span class="info-value-main">{{ teaching.adscripcion ||
                          ('TEACHING_MODULE.ASSISTANTS.NOT_AVAILABLE' | translate) }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Detalles expandidos (Lista de Eventos) -->
                  <div class="expanded-details" *ngIf="isCardExpanded(teaching.id)">
                    <div class="details-separator"></div>

                    <h6 class="text-muted mb-3"><i class="fa fa-history me-2"></i>Historial de Eventos</h6>

                    <!-- Grid de tarjetas de eventos -->
                    <div class="events-grid">
                      <div class="event-card" *ngFor="let event of teaching.events">
                        <!-- Header del evento: Nombre y Fecha -->
                        <div class="event-header">
                          <div class="event-title">
                            <i class="fa fa-calendar-check me-2"></i>{{ event.nombre_evento }}
                          </div>
                          <div class="event-date">
                            <i class="fa fa-clock me-1"></i>{{ formatDate(event.fecha) }}
                          </div>
                        </div>

                        <!-- Body del evento: Info detallada -->
                        <div class="event-body">
                          <!-- Chips de información -->
                          <div class="event-info-chips">
                            <span class="info-chip" title="Modalidad">
                              <i class="fa fa-desktop"></i>{{ event.modalidad || getModalidadNombre(event.modalidad_id)
                              }}
                            </span>
                            <span class="info-chip" title="Participación">
                              <i class="fa fa-users"></i>{{ event.participacion ||
                              getParticipacionNombre(event.participacion_id) }}
                            </span>
                            <span class="info-chip" title="Horas">
                              <i class="fa fa-hourglass-half"></i>{{ formatHoras(event.horas) }}
                            </span>
                            <span class="info-chip" title="Foja" *ngIf="event.foja">
                              <i class="fa fa-file-invoice"></i>Foja: {{ event.foja }}
                            </span>
                          </div>

                          <!-- Tema (si existe) -->
                          <div class="event-theme" *ngIf="event.tema && event.tema !== 'N/A'">
                            <span class="theme-label">Tema:</span> {{ event.tema }}
                          </div>
                        </div>

                        <!-- Botón de eliminar (esquina superior derecha) -->
                        <button *ngIf="canDelete()" class="btn-delete-event" (click)="selectEvent(event)"
                          data-bs-toggle="modal" data-bs-target="#delete_event_list"
                          title="{{ 'TEACHING_MODULE.ASSISTANTS.DELETE' | translate }}">
                          <i class="fa fa-times"></i>
                        </button>
                      </div>

                      <!-- Estado vacío -->
                      <div class="empty-events" *ngIf="!teaching.events || teaching.events.length === 0">
                        <i class="fa fa-calendar-times mb-2"></i>
                        <p class="mb-0">Sin eventos registrados</p>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <!-- Paginación de resultados -->
              <div class="pagination-wrapper mt-4" *ngIf="!loading && teachingList.length > 0">
                <!-- Información de paginación -->
                <div class="pagination-info">
                  <i class="fa fa-info-circle me-2"></i>
                  {{ 'TEACHING_MODULE.ASSISTANTS.SHOWING' | translate }} {{ rangeStart }}
                  {{ 'TEACHING_MODULE.ASSISTANTS.TO' | translate }} {{ rangeEnd }}
                  {{ 'TEACHING_MODULE.ASSISTANTS.OF' | translate }} {{ totalData }} {{
                  'TEACHING_MODULE.ASSISTANTS.RECORDS' | translate }}
                  <span *ngIf="totalData < stats.total" class="text-muted ms-1">
                    (filtrado de {{ stats.total }} registros totales)
                  </span>
                </div>
                <!-- Navegación de paginación (solo si hay más de una página) -->
                <!-- Navegación de paginación (solo si hay más de una página) -->
                <nav *ngIf="totalPages > 1">
                  <ul class="pagination mb-0">
                    <!-- Botón para ir a la página anterior -->
                    <li class="page-item" [class.disabled]="currentPage === 1 || loading">
                      <a class="page-link" href="javascript:void(0);" (click)="moveToPage(currentPage - 1)"
                        [attr.aria-disabled]="currentPage === 1 || loading">
                        <i class="fa fa-chevron-left me-1"></i>{{ 'TEACHING_MODULE.ASSISTANTS.PREVIOUS' | translate }}
                      </a>
                    </li>

                    <!-- Botones de páginas individuales -->
                    <li class="page-item" *ngFor="let page of visiblePages" [class.active]="page === currentPage"
                      [class.disabled]="loading || page === '...'">

                      <!-- Si es un número, es clickable -->
                      <a class="page-link" *ngIf="page !== '...'" href="javascript:void(0);" (click)="moveToPage(page)"
                        [attr.aria-disabled]="loading">
                        {{ page }}
                      </a>

                      <!-- Si es '...', no es clickable -->
                      <span class="page-link" *ngIf="page === '...'">
                        ...
                      </span>
                    </li>

                    <!-- Botón para ir a la página siguiente -->
                    <li class="page-item" [class.disabled]="currentPage === totalPages || loading">
                      <a class="page-link" href="javascript:void(0);" (click)="moveToPage(currentPage + 1)"
                        [attr.aria-disabled]="currentPage === totalPages || loading">
                        {{ 'TEACHING_MODULE.ASSISTANTS.NEXT' | translate }}<i class="fa fa-chevron-right ms-1"></i>
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Eliminación para confirmar borrado de enseñanza -->
  <div class="modal fade" id="delete_teaching" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-4">
          <!-- Imagen de advertencia -->
          <img src="assets/img/sent.png" alt="" width="50" height="46" />
          <!-- Mensaje de confirmación -->
          <h5 class="mt-3" *ngIf="teaching_selected">
            {{ 'TEACHING_MODULE.ASSISTANTS.DELETE_CONFIRMATION' | translate }} <strong>{{ teaching_selected.nombre
              }}</strong>?
          </h5>
          <!-- Botones para cancelar o confirmar eliminación -->
          <div class="mt-4 d-flex justify-content-center gap-3">
            <button class="btn btn-light" data-bs-dismiss="modal">{{ 'TEACHING_MODULE.ASSISTANTS.CANCEL' | translate
              }}</button>
            <button class="btn btn-danger" (click)="deleteTeaching()" data-bs-dismiss="modal">{{
              'TEACHING_MODULE.ASSISTANTS.DELETE' | translate }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Eliminación para confirmar borrado de EVENTO -->
  <div class="modal fade" id="delete_event_list" tabindex="-1" aria-labelledby="deleteEventModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-4">
          <!-- Imagen de advertencia -->
          <img src="assets/img/sent.png" alt="" width="50" height="46" />
          <!-- Mensaje de confirmación -->
          <h5 class="mt-3" *ngIf="event_selected">
            ¿Está seguro de eliminar el evento <strong>{{ event_selected.nombre_evento }}</strong>?
          </h5>
          <!-- Botones para cancelar o confirmar eliminación -->
          <div class="mt-4 d-flex justify-content-center gap-3">
            <button class="btn btn-light" data-bs-dismiss="modal">{{ 'TEACHING_MODULE.ASSISTANTS.CANCEL' | translate
              }}</button>
            <button class="btn btn-danger" (click)="deleteEvent()" data-bs-dismiss="modal">{{
              'TEACHING_MODULE.ASSISTANTS.DELETE' | translate }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón flotante de ayuda para iniciar el tour -->
  <button class="tour-help-button" (click)="startAssistantsListTour()" title="{{ 'TOUR.HELP_BUTTON' | translate }}"
    type="button">
    <i class="fa fa-question"></i>
  </button>