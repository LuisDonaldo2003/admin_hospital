<!-- Contenedor principal de la página de listado de pacientes archivados -->
<div class="page-wrapper">
  <!-- Contenido principal -->
  <div class="content list-staff">

    <!-- Encabezado de la página con breadcrumb de navegación -->
    <div class="page-header mb-4">
      <div class="row">
        <div class="col-sm-12">
          <!-- Breadcrumb para mostrar la ruta actual -->
          <ol class="breadcrumb bg-light p-2 rounded">
            <li class="breadcrumb-item">{{ 'ARCHIVE.LIST_PATIENT.PATIENT' | translate }} <span>&gt;</span></li>
            <li class="breadcrumb-item active">{{ 'ARCHIVE.LIST_PATIENT.BREADCRUMB_LIST' | translate }}</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Sección de filtros y búsqueda mejorada -->
    <div class="filters-card mb-4">
      <div class="filters-header mb-3">
        <h5 class="mb-0 fw-semibold">
          <i class="fa fa-filter me-2"></i>{{ 'ARCHIVE.LIST_PATIENT.FILTERS_TITLE' | translate }}
        </h5>
      </div>

      <!-- Fila de búsqueda y acciones combinada -->
      <div class="row g-3 align-items-end">
        <!-- Búsqueda por expediente -->
        <div class="col-lg-3 col-md-6">
          <div class="input-group search-input-group">
            <span class="input-group-text">
              <i class="fa fa-folder"></i>
            </span>
            <input type="text" class="form-control" [placeholder]="'ARCHIVE.LIST_PATIENT.SEARCH_RECORD' | translate"
              [(ngModel)]="archiveNumberSearch" (keyup.enter)="onArchiveNumberSearch()"
              (input)="archiveNumberSearch === '' && onArchiveNumberSearch()" [disabled]="isLoading" maxlength="10">
          </div>
        </div>

        <!-- Búsqueda por nombre -->
        <div class="col-lg-3 col-md-6">
          <div class="input-group search-input-group">
            <span class="input-group-text">
              <i class="fa fa-user"></i>
            </span>
            <input type="text" class="form-control" [placeholder]="'ARCHIVE.LIST_PATIENT.SEARCH_NAME' | translate"
              [(ngModel)]="nameSearch" (keyup.enter)="onNameSearch()" (input)="nameSearch === '' && onNameSearch()"
              [disabled]="isLoading" minlength="2">
          </div>
        </div>

        <!-- Ordenar -->
        <div class="col-lg-2 col-md-4">
          <button class="btn btn-outline-secondary w-100" (click)="toggleSort()" [disabled]="isLoading">
            <i class="fa"
              [ngClass]="{'fa-sort-numeric-down': sortDir === 'asc', 'fa-sort-numeric-up': sortDir === 'desc'}"></i>
            {{ sortDir === 'asc' ? 'Orden: Asc' : 'Orden: Desc' }}
          </button>
        </div>

        <!-- Limpiar -->
        <div class="col-lg-2 col-md-4">
          <button class="btn btn-clear w-100" (click)="clearAllFilters()" [disabled]="isLoading">
            <i class="fa fa-refresh me-2"></i>
            {{ 'ARCHIVE.LIST_PATIENT.CLEAR_FILTERS' | translate }}
          </button>
        </div>

        <!-- Agregar -->
        <div class="col-lg-2 col-md-4">
          <button class="btn btn-add-patient w-100" [routerLink]="['/archives/add_archive']" [disabled]="isLoading">
            <i class="fa fa-plus me-2"></i>
            {{ 'ARCHIVE.LIST_PATIENT.ADD_PATIENT' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla de resultados de pacientes archivados -->
    <div class="row">
      <div class="col-sm-12">
        <div class="card card-list shadow border-0">
          <div class="card-body">

            <!-- Encabezado de la tabla con totales y spinner de carga -->
            <div class="stats-bar mb-4">
              <div class="stat-item">
                <i class="fa fa-database me-2"></i>
                <span class="stat-label">{{ 'ARCHIVE.LIST_PATIENT.GLOBAL_TOTAL' | translate }}:</span>
                <span class="stat-value">{{ totalRecords }}</span>
              </div>
              <div class="d-flex align-items-center gap-3">
                <div class="stat-item">
                  <i class="fa fa-file-medical me-2"></i>
                  <span class="stat-label">{{ 'ARCHIVE.LIST_PATIENT.CURRENT_PAGE_RESULTS' | translate }}:</span>
                  <span class="stat-value">{{ displayedArchives.length }}</span>
                </div>
                <div *ngIf="isLoading" class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">{{ 'ARCHIVE.LIST_PATIENT.LOADING' | translate }}...</span>
                </div>
              </div>
            </div>

            <!-- Mensaje cuando no hay resultados en la búsqueda -->
            <div *ngIf="!isLoading && displayedArchives.length === 0" class="empty-state">
              <div class="empty-icon">
                <i class="fa fa-folder-open"></i>
              </div>
              <h5>{{ 'ARCHIVE.LIST_PATIENT.NO_RESULTS' | translate }}</h5>
              <p *ngIf="hasActiveFilters">
                {{ 'ARCHIVE.LIST_PATIENT.TRY_DIFFERENT_FILTERS' | translate }}
              </p>
              <button *ngIf="hasActiveFilters" class="btn btn-clear" (click)="clearAllFilters()">
                <i class="fa fa-refresh me-2"></i>
                {{ 'ARCHIVE.LIST_PATIENT.CLEAR_FILTERS' | translate }}
              </button>
            </div>

            <!-- Vista de cards horizontales (solo si hay resultados) -->
            <div class="patients-grid" *ngIf="!isLoading && displayedArchives.length > 0">
              <div class="patient-card" [class.original-search]="a.is_original_search"
                *ngFor="let a of displayedArchives; trackBy: trackByArchiveNumber; let i = index"
                (click)="closeAllDropdowns()">

                <!-- Encabezado de la card con expediente y acciones -->
                <div class="patient-card-header">
                  <div class="expediente-section">
                    <i class="fa fa-folder-open"></i>
                    <span class="expediente-number">#{{ a.archive_number }}</span>
                  </div>

                  <!-- Si tiene al menos un permiso (editar o eliminar) -->
                  <div class="action-buttons-compact" *ngIf="canEditArchive() || canDeleteArchive()">
                    <!-- Botón Editar - solo si tiene permiso -->
                    <button *ngIf="canEditArchive()" class="btn-icon btn-edit"
                      [routerLink]="['/archives/list_archive/edit_archive/', a.archive_number]"
                      title="{{ 'ARCHIVE.LIST_PATIENT.EDIT' | translate }}">
                      <i class="fa fa-pen"></i>
                    </button>
                    <!-- Botón Eliminar - solo si tiene permiso -->
                    <button *ngIf="canDeleteArchive()" class="btn-icon btn-delete"
                      (click)="selectArchive(a); closeAllDropdowns()" data-bs-toggle="modal"
                      data-bs-target="#deleteModal" title="{{ 'ARCHIVE.LIST_PATIENT.DELETE' | translate }}">
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>

                  <!-- Si no tiene ningún permiso -->
                  <span class="badge badge-no-permission" *ngIf="!canEditArchive() && !canDeleteArchive()">
                    <i class="fa fa-ban me-1"></i>{{ 'ARCHIVE.LIST_PATIENT.NO_PERMISSIONS' | translate }}
                  </span>
                </div>

                <!-- Cuerpo de la card con información del paciente en layout horizontal -->
                <div class="patient-card-body">
                  <!-- Grid horizontal con toda la información -->
                  <div class="patient-horizontal-info">

                    <!-- Nombre completo -->
                    <div class="info-block info-name">
                      <i class="fa fa-user-circle"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'ARCHIVE.LIST_PATIENT.FULL_NAME_LABEL' | translate }}</span>
                        <span class="info-value-main">{{ a.name }} {{ a.last_name_father }} {{ a.last_name_mother
                          }}</span>
                      </div>
                    </div>

                    <!-- Edad -->
                    <div class="info-block">
                      <i class="fa fa-birthday-cake"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'ARCHIVE.LIST_PATIENT.AGE_LABEL' | translate }}</span>
                        <span class="info-value-main">{{ a.age }} {{ getAgeUnitLabel(a.age_unit) }}</span>
                      </div>
                    </div>

                    <!-- Género -->
                    <div class="info-block">
                      <i class="fa fa-venus-mars"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'ARCHIVE.LIST_PATIENT.GENDER_LABEL' | translate }}</span>
                        <span class="info-value-main">{{ a.gender?.name || 'N/D' }}</span>
                      </div>
                    </div>

                    <!-- Ubicación -->
                    <div class="info-block info-location">
                      <i class="fa fa-map-marker-alt"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'ARCHIVE.LIST_PATIENT.LOCATION_LABEL' | translate }}</span>
                        <span class="info-value-main">
                          {{ a.location_text || 'Sin localidad' }} · {{ a.municipality_text || 'Sin municipio' }} · {{
                          a.state_text || 'Sin estado' }}
                        </span>
                      </div>
                    </div>

                    <!-- Fecha de ingreso -->
                    <div class="info-block">
                      <i class="fa fa-calendar-check"></i>
                      <div class="info-details">
                        <span class="info-label-small">{{ 'ARCHIVE.LIST_PATIENT.ADMISSION_LABEL' | translate }}</span>
                        <span class="info-value-main">{{ a.admission_date || 'N/D' }}</span>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>

            <!-- Paginación de resultados -->
            <div class="pagination-wrapper mt-4" *ngIf="!isLoading && displayedArchives.length > 0">
              <!-- Información de paginación -->
              <div class="pagination-info">
                <i class="fa fa-info-circle me-2"></i>
                {{ 'ARCHIVE.LIST_PATIENT.SHOWING' | translate }} {{ (currentPage - 1) * pageSize + 1 }}
                {{ 'ARCHIVE.LIST_PATIENT.TO' | translate }} {{ (currentPage - 1) * pageSize + displayedArchives.length
                }}
                {{ 'ARCHIVE.LIST_PATIENT.OF' | translate }} {{ totalRecords }} {{ 'ARCHIVE.LIST_PATIENT.RECORDS' |
                translate }}
              </div>
              <!-- Navegación de paginación (solo si hay más de una página) -->
              <nav *ngIf="totalPages > 1">
                <ul class="pagination mb-0">
                  <!-- Botón para ir a la página anterior -->
                  <li class="page-item" [class.disabled]="currentPage === 1 || isLoading">
                    <a class="page-link" href="javascript:void(0);" (click)="changePage(currentPage - 1)"
                      [attr.aria-disabled]="currentPage === 1 || isLoading">
                      <i class="fa fa-chevron-left me-1"></i>{{ 'ARCHIVE.LIST_PATIENT.PREVIOUS' | translate }}
                    </a>
                  </li>
                  <!-- Botones de páginas individuales -->
                  <li class="page-item" *ngFor="let page of paginationRange" [class.active]="page === currentPage"
                    [class.disabled]="page === '...' || isLoading">
                    <a class="page-link" href="javascript:void(0);"
                      (click)="typeof page === 'number' && changePage(page)"
                      [attr.aria-disabled]="page === '...' || isLoading">
                      {{ page }}
                    </a>
                  </li>
                  <!-- Botón para ir a la página siguiente -->
                  <li class="page-item" [class.disabled]="currentPage === totalPages || isLoading">
                    <a class="page-link" href="javascript:void(0);" (click)="changePage(currentPage + 1)"
                      [attr.aria-disabled]="currentPage === totalPages || isLoading">
                      {{ 'ARCHIVE.LIST_PATIENT.NEXT' | translate }}<i class="fa fa-chevron-right ms-1"></i>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Eliminación para confirmar borrado de paciente archivado -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-4">
        <!-- Imagen de advertencia -->
        <img src="assets/img/sent.png" alt="" width="50" height="46" />
        <!-- Mensaje de confirmación con número de expediente -->
        <h5 class="mt-3" *ngIf="archive_selected">
          {{ 'ARCHIVE.LIST_PATIENT.DELETE_CONFIRMATION3' | translate }} <strong>#{{ archive_selected.archive_number
            }}</strong>?
        </h5>
        <!-- Botones para cancelar o confirmar eliminación -->
        <div class="mt-4 d-flex justify-content-center gap-3">
          <button class="btn btn-light" data-bs-dismiss="modal">{{ 'ARCHIVE.LIST_PATIENT.CANCEL' | translate }}</button>
          <button class="btn btn-danger" (click)="deleteArchive()" data-bs-dismiss="modal">{{
            'ARCHIVE.LIST_PATIENT.DELETE' | translate }}</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Botón flotante de ayuda para iniciar el tour -->
<button class="tour-help-button" (click)="startArchiveListTour()"
  title="{{ 'ARCHIVE.LIST_PATIENT.HELP_BUTTON' | translate }}" type="button">
  <i class="fa fa-question"></i>
</button>