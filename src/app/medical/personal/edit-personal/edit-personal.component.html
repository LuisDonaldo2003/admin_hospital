<!-- Contenedor principal de la página para editar personal -->
<div class="page-wrapper">
  <div class="content add-staff-form" [class.dark-mode-container]="isDarkMode()">
    <!-- Encabezado y breadcrumb de navegación -->
    <div class="page-header mb-4">
      <div class="row">
        <div class="col-sm-12">
          <ol class="breadcrumb bg-light p-2 rounded">
            <li class="breadcrumb-item"><a href="#"
                (click)="$event.preventDefault(); goToList()">{{'PERSONAL.EDIT_PERSONAL.EDIT' | translate}} ></a></li>
            <li class="breadcrumb-item active">{{'PERSONAL.EDIT_PERSONAL.TITLE' | translate}}</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Loading spinner mientras se cargan los datos -->
    <div class="row justify-content-center" *ngIf="isLoading">
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{{'PERSONAL.EDIT_PERSONAL.LOADING' | translate}}</span>
        </div>
        <p class="mt-3 text-muted">{{'PERSONAL.EDIT_PERSONAL.LOADING_DATA' | translate}}</p>
      </div>
    </div>

    <div class="row justify-content-center" *ngIf="!isLoading">
      <div class="col-lg-10 col-xl-8">
        <!-- Tarjeta principal del formulario -->
        <div class="card card-form shadow border-0">
          <div class="card-body px-5 py-4">
            <!-- Título del formulario -->
            <h3 class="text-center mb-4 fw-bold">{{'PERSONAL.EDIT_PERSONAL.EDIT_PERSONAL' | translate}}</h3>

            <!-- Formulario para editar datos básicos -->
            <form (keydown.enter)="saveBasicData()" class="form-section" novalidate>
              <div class="row g-3">

                <!-- Campo: Nombre -->
                <div class="col-md-6">
                  <label class="form-label">{{'PERSONAL.EDIT_PERSONAL.NAME' | translate}}(s) *</label>
                  <input type="text" class="form-control" [(ngModel)]="nombre" name="nombre"
                    placeholder="{{ 'PERSONAL.EDIT_PERSONAL.NAME_PLACEHOLDER' | translate }}" required />
                </div>

                <!-- Campo: Apellidos -->
                <div class="col-md-6">
                  <label class="form-label">{{'PERSONAL.EDIT_PERSONAL.LAST_NAME' | translate}} *</label>
                  <input type="text" class="form-control" [(ngModel)]="apellidos" name="apellidos"
                    placeholder="{{ 'PERSONAL.EDIT_PERSONAL.LAST_NAME_PLACEHOLDER' | translate }}" required />
                </div>

                <!-- Campo: Tipo de Personal -->
                <div class="col-md-6">
                  <label class="form-label">{{'PERSONAL.EDIT_PERSONAL.TYPE' | translate}} *</label>
                  <select class="form-select" [(ngModel)]="tipo" name="tipo" required>
                    <option value="">{{ 'PERSONAL.EDIT_PERSONAL.SELECT_TYPE' | translate }}</option>
                    <option value="Clínico">Clínico</option>
                    <option value="No Clínico">No Clínico</option>
                  </select>
                </div>

                <!-- Fecha de Ingreso (solo lectura) -->
                <div class="col-md-6">
                  <label class="form-label">{{'PERSONAL.EDIT_PERSONAL.ENTRY_DATE' | translate}}</label>
                  <input type="text" class="form-control" [value]="fechaIngreso" readonly />
                </div>

                <!-- Campo: RFC -->
                <div class="col-md-6">
                  <label class="form-label">{{'PERSONAL.EDIT_PERSONAL.RFC' | translate}} *</label>
                  <input type="text" class="form-control text-uppercase" [(ngModel)]="rfc" name="rfc"
                    placeholder="{{ 'PERSONAL.EDIT_PERSONAL.RFC_PLACEHOLDER' | translate }}" maxlength="13" required />
                </div>

                <!-- Campo: Número de Checador -->
                <div class="col-md-6">
                  <label class="form-label">{{'PERSONAL.EDIT_PERSONAL.CHECKER_NUMBER' | translate}} *</label>
                  <input type="text" class="form-control" [(ngModel)]="numeroChecador" name="numeroChecador"
                    placeholder="{{ 'PERSONAL.EDIT_PERSONAL.CHECKER_NUMBER_PLACEHOLDER' | translate }}" pattern="[0-9]*"
                    required />
                </div>

                <!-- Campo: Activo -->
                <div class="col-md-12">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked" [(ngModel)]="activo"
                      name="activo">
                    <label class="form-check-label" for="flexSwitchCheckChecked">Personal Activo</label>
                  </div>
                </div>

              </div>

              <!-- Botones de acción para datos básicos -->
              <div class="text-end mt-4 d-flex gap-2 justify-content-end form-actions">
                <div class="mt-4" *ngIf="text_success">
                  <span class="text-success me-3">{{ text_success }}</span>
                </div>
                <div class="mt-4" *ngIf="text_validation">
                  <span class="text-danger me-3">{{ text_validation }}</span>
                </div>

                <button type="button" class="btn btn-primary px-4 btn-save" (click)="saveBasicData()"
                  [disabled]="isSaving">
                  <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                  {{ isSaving ? ('PERSONAL.EDIT_PERSONAL.SAVING' | translate) : ('PERSONAL.EDIT_PERSONAL.UPDATING' |
                  translate) }}
                </button>
                <button type="button" class="btn btn-outline-secondary px-4" (click)="goToList()">
                  <i class="fa fa-list"></i> {{'PERSONAL.EDIT_PERSONAL.VIEW_LIST' | translate}}
                </button>
              </div>

            </form>

            <!-- Sección de Documentos -->
            <div class="form-section mt-5 border-top pt-4">
              <h5 class="form-section-title mb-3">
                <i class="fa fa-file-pdf-o text-danger me-2"></i>
                Gestión de Documentos (PDF)
              </h5>
              <p class="text-muted mb-3">
                Los documentos se suben y eliminan de forma inmediata.
              </p>

              <div *ngIf="isUploadingDoc" class="alert alert-info">
                <i class="fa fa-spinner fa-spin me-2"></i> Subiendo documento...
              </div>

              <div class="row g-4 transition-all">

                <!-- Iterar sobre los tipos de documentos requeridos -->
                <div class="col-md-6" *ngFor="let docName of documentosRequeridos">
                  <div class="document-upload-card h-100">
                    <div class="upload-header d-flex justify-content-between align-items-center">
                      <div>
                        <i class="fa fa-file-text-o text-primary me-2"></i>
                        <label class="form-label mb-0">{{ docName }}</label>
                      </div>
                      <span *ngIf="hasDocument(docName)" class="badge bg-success"><i class="fa fa-check"></i></span>
                    </div>

                    <div class="upload-area" [class.has-file]="hasDocument(docName)" (dragover)="onDragOver($event)"
                      (drop)="onDrop($event, docName)">

                      <!-- Input siempre visible (fuera de ngIf) para que funcionen los labels -->
                      <input type="file" [id]="'file-' + docName" class="d-none" accept=".pdf"
                        (change)="onFileSelected($event, docName)" [multiple]="docName === 'Constancias de cursos'">

                      <!-- Lista de archivos existentes para este tipo -->
                      <div *ngIf="hasDocument(docName)" class="upload-success w-100">
                        <div *ngFor="let doc of getExistingDocs(docName)"
                          class="d-flex align-items-center justify-content-between p-2 mb-2 bg-light rounded border">
                          <div class="text-truncate me-2" style="max-width: 150px;">
                            <small class="d-block text-truncate" title="{{doc.nombre_archivo}}">{{ doc.nombre_archivo
                              }}</small>
                            <small class="text-muted" style="font-size: 0.7em">{{ formatFileSize(doc.file_size)
                              }}</small>
                          </div>
                          <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary"
                              (click)="downloadDocument(doc.id!, doc.nombre_archivo)" title="Descargar">
                              <i class="fa fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="deleteDocument(doc.id!)"
                              title="Eliminar">
                              <i class="fa fa-trash"></i>
                            </button>
                          </div>
                        </div>

                        <!-- Boton extra para constancias -->
                        <div *ngIf="docName === 'Constancias de cursos'" class="text-center mt-2">
                          <label [for]="'file-' + docName" class="btn btn-outline-primary btn-sm">
                            <i class="fa fa-plus"></i> Agregar otro
                          </label>
                        </div>

                        <!-- Boton de reemplazo para otros documentos (opcional, o reusar el zona de carga si no hay docs)
                                 En este caso, para no constancias, si ya hay uno, podriamos querer reemplazarlo.
                                 Para seguir el estilo de AddPersonal, si ya hay archivo, mostramos el archivo y opción de borrar.
                                 Si el usuario quiere reemplazar, borra y sube, o podemos poner un botón "Reemplazar".
                                 AddPersonal no tiene "Reemplazar" explícito, solo borrar. 
                                 Pero AddPersonal permite "drag over" para reemplazar? No, AddPersonal oculta el dropzone si ya hay archivo.
                                 Aquí, si ocultamos dropzone, usuario debe borrar primero. 
                                 Pero podemos dejar un boton 'Cambiar' si se desea.
                                 Haremos coincidir AddPersonal: Solo borrar. 
                            -->
                      </div>

                      <!-- Zona de carga (visible si NO hay docs, O si es constancias (aunque ya haya, pero queremos que se vea abajo? 
                             No, AddPersonal oculta el dropzone grande si ya hay docs, y pone el boton 'Agregar otro'.
                             Asi que imitaremos eso.) -->
                      <div *ngIf="!hasDocument(docName)"
                        class="upload-placeholder text-center p-3 border rounded border-dashed">

                        <i class="fa fa-cloud-upload fa-2x text-muted mb-2"></i>
                        <p class="text-muted small mb-1">{{ 'PERSONAL.EDIT_PERSONAL.DRAG_FILE_HERE' | translate }}</p>
                        <div class="d-grid gap-2">
                          <label [for]="'file-' + docName" class="btn btn-sm btn-outline-primary cursor-pointer">
                            Seleccionar
                          </label>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

              </div>
            </div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Botón flotante de ayuda para iniciar el tour del formulario de editar personal -->
  <button class="tour-help-button" (click)="startEditPersonalTour()" title="{{ 'TOUR.HELP_BUTTON' | translate }}"
    type="button">
    <i class="fa fa-question"></i>
  </button>
</div>