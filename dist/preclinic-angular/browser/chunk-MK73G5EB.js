import{a as n}from"./chunk-VOEI7TUP.js";import{a as m}from"./chunk-UYUIDONG.js";import{B as l,Dc as S,T as f,W as u,d as a,n as i,o as h,q as c,sc as p,tc as k,x as g}from"./chunk-VPSRVESD.js";var j=(()=>{class o{constructor(t,e){this.router=t,this.http=e,this.userSubject=new a(null),this.user$=this.userSubject.asObservable(),this.refreshInProgress=!1,this.refreshTokenSubject=new a(null),this.HEARTBEAT_INTERVAL=90*1e3,this.getLocalStorage()}getLocalStorage(){if(localStorage.getItem("token")&&localStorage.getItem("user")){let t=localStorage.getItem("user");this.token=localStorage.getItem("token"),this.userSubject.next(JSON.parse(t||"")),this.token&&!this.isTokenExpired()&&this.startUserActivityTracking()}else this.token=null,this.userSubject.next(null)}login(t,e){let s=n+"/auth/login";return this.http.post(s,{email:t,password:e}).pipe(c(r=>r&&r.access_token?(this.savelocalStorage(r),{success:!0}):{success:!1}),l(r=>r.status===403&&r.error?.unverified?(localStorage.setItem("pending_email",t),this.router.navigate(["/verify-code"]),i({success:!1,unverified:!0})):i({success:!1})))}savelocalStorage(t){return t&&t.access_token?(t.user&&Array.isArray(t.user.roles)&&(t.user.roles=t.user.roles.map(e=>typeof e=="string"?e.trim():e)),localStorage.setItem("token",t.access_token),localStorage.setItem("user",JSON.stringify(t.user)),localStorage.setItem("authenticated","true"),this.userSubject.next(t.user),this.token=t.access_token,this.startUserActivityTracking(),!0):!1}logout(){this.stopUserActivityTracking();let t=n+"/auth/logout";this.http.post(t,{}).subscribe({next:()=>{this.clearLocalStorage(),this.navigateToLogin()},error:()=>{this.clearLocalStorage(),this.navigateToLogin()}})}clearLocalStorage(){this.stopUserActivityTracking(),localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("authenticated"),this.userSubject.next(null),this.token=null}navigateToLogin(){this.router.navigate([m.login]).then(()=>{window.location.reload()})}get user(){return JSON.parse(localStorage.getItem("user")||"null")}isTokenExpiringSoon(){let t=localStorage.getItem("token");if(!t)return!0;try{let e=JSON.parse(atob(t.split(".")[1])),s=Math.floor(Date.now()/1e3);return e.exp-s<900}catch{return!0}}isTokenExpired(){let t=localStorage.getItem("token");if(!t)return!0;try{let e=JSON.parse(atob(t.split(".")[1]));return Math.floor(Date.now()/1e3)>=e.exp}catch{return!0}}refreshToken(){if(this.refreshInProgress)return this.refreshTokenSubject.asObservable();this.refreshInProgress=!0,this.refreshTokenSubject.next(null);let t=n+"/auth/refresh";return this.http.post(t,{}).pipe(c(e=>{if(e&&e.access_token)return this.savelocalStorage(e),this.refreshTokenSubject.next(e.access_token),this.refreshInProgress=!1,e.access_token;throw new Error("Token refresh failed")}),l(e=>(this.refreshInProgress=!1,this.refreshTokenSubject.next(null),this.logout(),h(()=>e))))}getValidToken(){return this.isTokenExpired()?this.isTokenExpiringSoon()&&!this.refreshInProgress?this.refreshToken():i(null):i(localStorage.getItem("token"))}logTokenInfo(){let t=localStorage.getItem("token");if(t)try{let e=JSON.parse(atob(t.split(".")[1])),s=Math.floor(Date.now()/1e3),r=e.exp,b=Math.floor((r-s)/3600),T=Math.floor((r-s)%3600/60)}catch{}}startUserActivityTracking(){this.stopUserActivityTracking(),this.token&&(this.sendHeartbeat(),this.heartbeatSubscription=g(this.HEARTBEAT_INTERVAL).subscribe(()=>{this.token?this.sendHeartbeat():this.stopUserActivityTracking()}))}stopUserActivityTracking(){this.heartbeatSubscription&&(this.heartbeatSubscription.unsubscribe(),this.heartbeatSubscription=void 0)}sendHeartbeat(){if(!this.token)return;let t=new p({Authorization:"Bearer "+this.token}),e=n+"/auth/heartbeat";this.http.post(e,{},{headers:t}).subscribe({next:()=>{},error:s=>{s.status===401&&this.logout()}})}static{this.\u0275fac=function(e){return new(e||o)(u(S),u(k))}}static{this.\u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{j as a};
