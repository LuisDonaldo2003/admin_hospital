import{a as n}from"./chunk-HPADJYSB.js";import{a as S}from"./chunk-7DIUBSS2.js";import{B as l,Ec as k,T as f,W as u,d as a,n as i,o as h,q as c,tc as p,uc as m,x as g}from"./chunk-6GTM3F5E.js";var A=(()=>{class o{constructor(e,t){this.router=e,this.http=t,this.userSubject=new a(null),this.user$=this.userSubject.asObservable(),this.refreshInProgress=!1,this.refreshTokenSubject=new a(null),this.HEARTBEAT_INTERVAL=90*1e3,this.getLocalStorage()}getLocalStorage(){if(localStorage.getItem("token")&&localStorage.getItem("user")){let e=localStorage.getItem("user");this.token=localStorage.getItem("token"),this.userSubject.next(JSON.parse(e||"")),this.token&&!this.isTokenExpired()&&this.startUserActivityTracking()}else this.token=null,this.userSubject.next(null)}login(e,t){let s=n+"/auth/login";return this.http.post(s,{email:e,password:t}).pipe(c(r=>r&&r.access_token?(this.savelocalStorage(r),{success:!0}):{success:!1}),l(r=>r.status===403&&r.error?.unverified?(localStorage.setItem("pending_email",e),this.router.navigate(["/verify-code"]),i({success:!1,unverified:!0})):i({success:!1})))}savelocalStorage(e){return e&&e.access_token?(e.user&&Array.isArray(e.user.roles)&&(e.user.roles=e.user.roles.map(t=>typeof t=="string"?t.trim():t)),localStorage.setItem("token",e.access_token),localStorage.setItem("user",JSON.stringify(e.user)),localStorage.setItem("authenticated","true"),this.userSubject.next(e.user),this.token=e.access_token,this.startUserActivityTracking(),!0):!1}logout(){this.stopUserActivityTracking();let e=n+"/auth/logout";this.http.post(e,{}).subscribe({next:()=>{this.clearLocalStorage(),this.navigateToLogin()},error:()=>{this.clearLocalStorage(),this.navigateToLogin()}})}clearLocalStorage(){this.stopUserActivityTracking(),localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("authenticated"),this.userSubject.next(null),this.token=null}navigateToLogin(){this.router.navigate([S.login]).then(()=>{window.location.reload()})}get user(){return JSON.parse(localStorage.getItem("user")||"null")}isTokenExpiringSoon(){let e=localStorage.getItem("token");if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1])),s=Math.floor(Date.now()/1e3);return t.exp-s<900}catch{return!0}}isTokenExpired(){let e=localStorage.getItem("token");if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1]));return Math.floor(Date.now()/1e3)>=t.exp}catch{return!0}}refreshToken(){if(this.refreshInProgress)return this.refreshTokenSubject.asObservable();this.refreshInProgress=!0,this.refreshTokenSubject.next(null);let e=n+"/auth/refresh";return this.http.post(e,{}).pipe(c(t=>{if(t&&t.access_token)return this.savelocalStorage(t),this.refreshTokenSubject.next(t.access_token),this.refreshInProgress=!1,t.access_token;throw new Error("Token refresh failed")}),l(t=>(this.refreshInProgress=!1,this.refreshTokenSubject.next(null),this.logout(),h(()=>t))))}getValidToken(){return this.isTokenExpired()?this.isTokenExpiringSoon()&&!this.refreshInProgress?this.refreshToken():i(null):i(localStorage.getItem("token"))}logTokenInfo(){let e=localStorage.getItem("token");if(e)try{let t=JSON.parse(atob(e.split(".")[1])),s=Math.floor(Date.now()/1e3),r=t.exp,b=Math.floor((r-s)/3600),d=Math.floor((r-s)%3600/60)}catch{}}startUserActivityTracking(){this.stopUserActivityTracking(),this.token&&(this.sendHeartbeat(),this.heartbeatSubscription=g(this.HEARTBEAT_INTERVAL).subscribe(()=>{this.token?this.sendHeartbeat():this.stopUserActivityTracking()}))}stopUserActivityTracking(){this.heartbeatSubscription&&(this.heartbeatSubscription.unsubscribe(),this.heartbeatSubscription=void 0)}sendHeartbeat(){if(!this.token)return;let e=new p({Authorization:"Bearer "+this.token}),t=n+"/auth/heartbeat";this.http.post(t,{},{headers:e}).subscribe({next:()=>{},error:s=>{s.status===401&&this.logout()}})}isLoggedIn(){return!!(this.token&&this.user&&!this.isTokenExpired())}getUserRole(){let e=this.user;return e?.role_name||e?.role?.name||null}getDefaultRouteForUser(){switch(this.getUserRole()){case"Director General":return"/dashboard";case"Administrador":return"/dashboard";case"Doctor":return"/medical/archives/list";case"Enfermera":case"Enfermero":return"/medical/archives/list";case"Recursos Humanos":return"/medical/personal";default:return"/dashboard"}}static{this.\u0275fac=function(t){return new(t||o)(u(k),u(m))}}static{this.\u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{A as a};
