import{a as i}from"./chunk-VOEI7TUP.js";import{a as p}from"./chunk-JB324THB.js";import{B as c,Dc as S,T as g,W as u,d as a,n,o as h,q as l,tc as f}from"./chunk-VPSRVESD.js";var j=(()=>{class s{constructor(e,t){this.router=e,this.http=t,this.userSubject=new a(null),this.user$=this.userSubject.asObservable(),this.refreshInProgress=!1,this.refreshTokenSubject=new a(null),this.getLocalStorage()}getLocalStorage(){if(localStorage.getItem("token")&&localStorage.getItem("user")){let e=localStorage.getItem("user");this.token=localStorage.getItem("token"),this.userSubject.next(JSON.parse(e||""))}else this.token=null,this.userSubject.next(null)}login(e,t){let o=i+"/auth/login";return this.http.post(o,{email:e,password:t}).pipe(l(r=>r&&r.access_token?(this.savelocalStorage(r),{success:!0}):{success:!1}),c(r=>r.status===403&&r.error?.unverified?(localStorage.setItem("pending_email",e),this.router.navigate(["/verify-code"]),n({success:!1,unverified:!0})):n({success:!1})))}savelocalStorage(e){return e&&e.access_token?(e.user&&Array.isArray(e.user.roles)&&(e.user.roles=e.user.roles.map(t=>typeof t=="string"?t.trim():t)),localStorage.setItem("token",e.access_token),localStorage.setItem("user",JSON.stringify(e.user)),localStorage.setItem("authenticated","true"),this.userSubject.next(e.user),!0):!1}logout(){let e=i+"/auth/logout";this.http.post(e,{}).subscribe({next:()=>{this.clearLocalStorage(),this.navigateToLogin()},error:()=>{this.clearLocalStorage(),this.navigateToLogin()}})}clearLocalStorage(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("authenticated"),this.userSubject.next(null),this.token=null}navigateToLogin(){this.router.navigate([p.login]).then(()=>{window.location.reload()})}get user(){return JSON.parse(localStorage.getItem("user")||"null")}isTokenExpiringSoon(){let e=localStorage.getItem("token");if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1])),o=Math.floor(Date.now()/1e3);return t.exp-o<900}catch{return!0}}isTokenExpired(){let e=localStorage.getItem("token");if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1]));return Math.floor(Date.now()/1e3)>=t.exp}catch{return!0}}refreshToken(){if(this.refreshInProgress)return this.refreshTokenSubject.asObservable();this.refreshInProgress=!0,this.refreshTokenSubject.next(null);let e=i+"/auth/refresh";return this.http.post(e,{}).pipe(l(t=>{if(t&&t.access_token)return this.savelocalStorage(t),this.refreshTokenSubject.next(t.access_token),this.refreshInProgress=!1,t.access_token;throw new Error("Token refresh failed")}),c(t=>(this.refreshInProgress=!1,this.refreshTokenSubject.next(null),this.logout(),h(()=>t))))}getValidToken(){return this.isTokenExpired()?this.isTokenExpiringSoon()&&!this.refreshInProgress?this.refreshToken():n(null):n(localStorage.getItem("token"))}logTokenInfo(){let e=localStorage.getItem("token");if(e)try{let t=JSON.parse(atob(e.split(".")[1])),o=Math.floor(Date.now()/1e3),r=t.exp,m=Math.floor((r-o)/3600),k=Math.floor((r-o)%3600/60)}catch{}}static{this.\u0275fac=function(t){return new(t||s)(u(S),u(f))}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{j as a};
