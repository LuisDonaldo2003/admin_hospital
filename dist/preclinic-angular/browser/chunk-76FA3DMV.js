import{a as p}from"./chunk-HPADJYSB.js";import{a as b}from"./chunk-DJRPQKOF.js";import{B as f,Bc as S,Dc as k,Kc as T,U as c,X as h,d as g,n as u,o as d,q as m,x as y}from"./chunk-JZRSYAJW.js";var I=(()=>{let o=class o{constructor(){this.user=null,this.loadUser()}loadUser(){let e=localStorage.getItem("user");e&&(this.user=JSON.parse(e))}refreshUser(){this.loadUser()}hasPermission(e){return this.hasAnyPermission([e])}hasAnyPermission(e){if(!this.user||!e||e.length===0)return!1;if(this.isPrivilegedRole())return!0;let t=this.getUserPermissions();return e.some(r=>t.includes(r))}hasAllPermissions(e){if(!this.user||!e||e.length===0)return!1;if(this.isPrivilegedRole())return!0;let t=this.getUserPermissions();return e.every(r=>t.includes(r))}hasRole(e){return this.hasAnyRole([e])}hasAnyRole(e){if(!this.user||!e||e.length===0)return!1;let t=this.getUserRoles(),r=e.map(s=>s.toLowerCase().trim());return t.some(s=>r.includes(s.toLowerCase().trim()))}isPrivilegedRole(){let e=["Director General","Subdirector General","Developer"];return this.hasAnyRole(e)}getUserPermissions(){if(!this.user)return[];let e=[];return this.user.permissions&&Array.isArray(this.user.permissions)&&e.push(...this.user.permissions),this.user.roles&&Array.isArray(this.user.roles)&&this.user.roles.forEach(t=>{t.permissions&&Array.isArray(t.permissions)&&e.push(...t.permissions),t.permission_pluck&&Array.isArray(t.permission_pluck)&&e.push(...t.permission_pluck)}),this.user.permission_pluck&&Array.isArray(this.user.permission_pluck)&&e.push(...this.user.permission_pluck),[...new Set(e)]}getUserRoles(){return!this.user||!this.user.roles?[]:this.user.roles.map(e=>typeof e=="string"?e:e.name).filter(e=>e)}getUser(){return this.user}isAuthenticated(){return!!this.user&&!!localStorage.getItem("token")}};o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"});let n=o;return n})();var v=(()=>{let o=class o{constructor(){this.DEFAULT_BORDER_COLOR="#0B7285",this.DEFAULT_CARD_BG_LIGHT="#F8FFFE",this.DEFAULT_CARD_BG_DARK="#1A2332"}applyUserTheme(){let e=JSON.parse(localStorage.getItem("user")||"null"),t=e?e.id:null;console.log("\u{1F3A8} ThemeService: Aplicando tema para usuario:",t);let r=this.getUserSetting("borderColor",this.DEFAULT_BORDER_COLOR,t),s=this.getUserSetting("cardBgColorLight",this.DEFAULT_CARD_BG_LIGHT,t),i=this.getUserSetting("cardBgColorDark",this.DEFAULT_CARD_BG_DARK,t),a=localStorage.getItem("darkMode")==="true";console.log("\u{1F3A8} Colores cargados:",{borderColor:r,cardBgColorLight:s,cardBgColorDark:i,isDarkMode:a}),this.applyThemeToDOM(r,s,i,a)}applyThemeToDOM(e,t,r,s){let i=document.documentElement,a=document.body;if(i.style.setProperty("--user-border-color",e),a.style.setProperty("--user-border-color",e),s){a.classList.add("dark-mode"),i.classList.add("dark-mode"),i.style.setProperty("--user-card-bg",r),a.style.setProperty("--user-card-bg",r);let l=localStorage.getItem("cardTextColorDark")||this.getContrastYIQ(r);i.style.setProperty("--user-card-text-color",l),a.style.setProperty("--user-card-text-color",l),console.log("\u{1F319} Modo Oscuro aplicado")}else{a.classList.remove("dark-mode"),i.classList.remove("dark-mode"),i.style.setProperty("--user-card-bg",t),a.style.setProperty("--user-card-bg",t);let l=localStorage.getItem("cardTextColorLight")||this.getContrastYIQ(t);i.style.setProperty("--user-card-text-color",l),a.style.setProperty("--user-card-text-color",l),console.log("\u2600\uFE0F Modo Claro aplicado")}console.log("\u2705 Tema aplicado exitosamente")}getUserSetting(e,t,r){if(!r)return console.warn(`\u26A0\uFE0F No hay userId, usando valor por defecto para ${e}`),t;let s=localStorage.getItem(`${e}_${r}`)||t;return console.log(`\u{1F4E6} ${e}_${r} = ${s}`),s}getContrastYIQ(e){e=e.replace("#","");let t=parseInt(e.substr(0,2),16),r=parseInt(e.substr(2,2),16),s=parseInt(e.substr(4,2),16);return(t*299+r*587+s*114)/1e3>=128?"#000000":"#ffffff"}clearUserTheme(){console.log("\u{1F9F9} Limpiando tema del usuario y aplicando valores por defecto"),this.applyThemeToDOM(this.DEFAULT_BORDER_COLOR,this.DEFAULT_CARD_BG_LIGHT,this.DEFAULT_CARD_BG_DARK,!1)}};o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"});let n=o;return n})();var O=(()=>{let o=class o{constructor(e,t,r,s){this.router=e,this.http=t,this.permissionService=r,this.themeService=s,this.userSubject=new g(null),this.user$=this.userSubject.asObservable(),this.refreshInProgress=!1,this.refreshTokenSubject=new g(null),this.HEARTBEAT_INTERVAL=90*1e3,this.getLocalStorage()}getLocalStorage(){if(localStorage.getItem("token")&&localStorage.getItem("user")){let e=localStorage.getItem("user");this.token=localStorage.getItem("token"),this.userSubject.next(JSON.parse(e||"")),this.token&&!this.isTokenExpired()&&this.startUserActivityTracking()}else this.token=null,this.userSubject.next(null)}login(e,t){let r=p+"/auth/login";return this.http.post(r,{email:e,password:t}).pipe(m(s=>s&&s.access_token?(this.savelocalStorage(s),{success:!0}):{success:!1}),f(s=>s.status===403&&s.error?.unverified?(localStorage.setItem("pending_email",e),this.router.navigate(["/verify-code"]),u({success:!1,unverified:!0})):u({success:!1})))}savelocalStorage(e){return e&&e.access_token?(e.user&&Array.isArray(e.user.roles)&&(e.user.roles=e.user.roles.map(t=>typeof t=="string"?t.trim():t)),localStorage.setItem("token",e.access_token),localStorage.setItem("user",JSON.stringify(e.user)),localStorage.setItem("authenticated","true"),this.userSubject.next(e.user),this.token=e.access_token,this.permissionService.refreshUser(),console.log("\u{1F3A8} Aplicando tema del usuario despu\xE9s del login"),setTimeout(()=>{this.themeService.applyUserTheme()},100),this.startUserActivityTracking(),!0):!1}logout(){this.stopUserActivityTracking();let e=p+"/auth/logout";this.http.post(e,{}).subscribe({next:()=>{this.clearLocalStorage(),this.navigateToLogin()},error:()=>{this.clearLocalStorage(),this.navigateToLogin()}})}clearLocalStorage(){this.stopUserActivityTracking(),console.log("\u{1F9F9} Limpiando tema al cerrar sesi\xF3n"),this.themeService.clearUserTheme(),localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("authenticated"),this.userSubject.next(null),this.token=null}navigateToLogin(){this.router.navigate([b.login]).then(()=>{window.location.reload()})}get user(){return JSON.parse(localStorage.getItem("user")||"null")}isTokenExpiringSoon(){let e=localStorage.getItem("token");if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1])),r=Math.floor(Date.now()/1e3);return t.exp-r<900}catch{return!0}}isTokenExpired(){let e=localStorage.getItem("token");if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1]));return Math.floor(Date.now()/1e3)>=t.exp}catch{return!0}}refreshToken(){if(this.refreshInProgress)return this.refreshTokenSubject.asObservable();this.refreshInProgress=!0,this.refreshTokenSubject.next(null);let e=p+"/auth/refresh";return this.http.post(e,{}).pipe(m(t=>{if(t&&t.access_token)return this.savelocalStorage(t),this.refreshTokenSubject.next(t.access_token),this.refreshInProgress=!1,t.access_token;throw new Error("Token refresh failed")}),f(t=>(this.refreshInProgress=!1,this.refreshTokenSubject.next(null),this.logout(),d(()=>t))))}getValidToken(){return this.isTokenExpired()?this.isTokenExpiringSoon()&&!this.refreshInProgress?this.refreshToken():u(null):u(localStorage.getItem("token"))}logTokenInfo(){let e=localStorage.getItem("token");if(e)try{let t=JSON.parse(atob(e.split(".")[1])),r=Math.floor(Date.now()/1e3),s=t.exp,i=Math.floor((s-r)/3600),a=Math.floor((s-r)%3600/60)}catch{}}startUserActivityTracking(){this.stopUserActivityTracking(),this.token&&(this.sendHeartbeat(),this.heartbeatSubscription=y(this.HEARTBEAT_INTERVAL).subscribe(()=>{this.token?this.sendHeartbeat():this.stopUserActivityTracking()}))}stopUserActivityTracking(){this.heartbeatSubscription&&(this.heartbeatSubscription.unsubscribe(),this.heartbeatSubscription=void 0)}sendHeartbeat(){if(!this.token)return;let e=new S({Authorization:"Bearer "+this.token}),t=p+"/auth/heartbeat";this.http.post(t,{},{headers:e}).subscribe({next:()=>{},error:r=>{r.status===401&&this.logout()}})}isLoggedIn(){return!!(this.token&&this.user&&!this.isTokenExpired())}getUserRole(){let e=this.user;return e?.role_name||e?.role?.name||null}getDefaultRouteForUser(){switch(this.getUserRole()){case"Director General":return"/dashboard";case"Administrador":return"/dashboard";case"Doctor":return"/medical/archives/list";case"Enfermera":case"Enfermero":return"/medical/archives/list";case"Recursos Humanos":return"/medical/personal";default:return"/dashboard"}}};o.\u0275fac=function(t){return new(t||o)(h(T),h(k),h(I),h(v))},o.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"});let n=o;return n})();export{I as a,O as b};
