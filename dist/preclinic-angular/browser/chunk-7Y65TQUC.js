import{a as c}from"./chunk-OEY3IFP3.js";import{a as n}from"./chunk-VOEI7TUP.js";import{T as l,W as a,b as o,d as h,sc as r,tc as u}from"./chunk-VPSRVESD.js";var S=(()=>{class i{constructor(t,e){this.http=t,this.authService=e,this.isOnlineSubject=new h(!1),this.isOnline$=this.isOnlineSubject.asObservable(),this.HEARTBEAT_INTERVAL=3e4,this.isInitialized=!1}initialize(){this.isInitialized||(this.isInitialized=!0,this.setupEventListeners(),this.startHeartbeat())}setupEventListeners(){window.addEventListener("beforeunload",()=>{this.setOfflineSync()}),window.addEventListener("unload",()=>{this.setOfflineSync()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.pauseHeartbeat():this.resumeHeartbeat()}),window.addEventListener("online",()=>{this.resumeHeartbeat()}),window.addEventListener("offline",()=>{this.pauseHeartbeat(),this.isOnlineSubject.next(!1)})}startHeartbeat(){this.authService.token&&(this.sendHeartbeat(),this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat()},this.HEARTBEAT_INTERVAL))}pauseHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}resumeHeartbeat(){!this.heartbeatInterval&&this.authService.token&&this.startHeartbeat()}sendHeartbeat(){if(!this.authService.token)return;let t=new r({Authorization:"Bearer "+this.authService.token,"Content-Type":"application/json"}),e=n+"/user/heartbeat";this.http.post(e,{timestamp:Date.now()},{headers:t}).subscribe({next:()=>{this.isOnlineSubject.next(!0)},error:s=>{console.warn("Error enviando heartbeat:",s),this.isOnlineSubject.next(!1)}})}setOfflineSync(){if(!this.authService.token)return;let t=n+"/user/offline",e=new Blob([JSON.stringify({timestamp:Date.now(),reason:"page_close"})],{type:"application/json"});navigator.sendBeacon(t,e),this.isOnlineSubject.next(!1)}setOffline(){if(!this.authService.token)return new o(s=>s.complete());let t=new r({Authorization:"Bearer "+this.authService.token,"Content-Type":"application/json"}),e=n+"/user/offline";return this.http.post(e,{timestamp:Date.now(),reason:"manual_logout"},{headers:t})}logout(){this.pauseHeartbeat(),this.setOffline().subscribe({next:()=>{this.isOnlineSubject.next(!1)},error:()=>{this.isOnlineSubject.next(!1)}})}ngOnDestroy(){this.pauseHeartbeat(),this.setOfflineSync()}get isCurrentlyOnline(){return this.isOnlineSubject.value}static{this.\u0275fac=function(e){return new(e||i)(a(u),a(c))}}static{this.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{S as a};
